
<% if @order.paid? %>
  <% class_vals = "card border-left-3 border-left-success rounded-left-0" %>
<% else %>
  <% class_vals = "card border-left-3 border-left-danger rounded-left-0" %>
<% end %>

<div class="<%= class_vals %>">
  <div class="card-body">
    <div class="d-sm-flex align-item-sm-center flex-sm-nowrap">
      <div>
        <h6 class="font-weight-semibold">Topic: <%= @order.topic %></h6>
        <ul class="list list-unstyled mb-0">
          <li>Order #: <%= @order.code %></li>
          <li>Issued on: <span class="font-weight-semibold"><%= @order.created_at%></span></li>
        </ul>
      </div>

      <div class="text-sm-right mb-0 mt-3 mt-sm-0 ml-auto">
        <h6 class="font-weight-semibold">Price: $<%= @order.price%></h6>
        <ul class="list list-unstyled mb-0">
          <li>Order Status: <span class="font-weight-semibold">In Progress</span></li>
          <li>
            Payment Status: 
              <% if @order.paid? %>
                <span class="font-weight-semibold badge bg-success badge-pill">Paid</span>
              <% else %>
                <span class="font-weight-semibold badge bg-danger badge-pill">Pending</span>
              <% end %>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card-footer d-sm-flex justify-content-sm-between align-items-sm-center">
    <span>
      <span class="badge badge-mark border-danger mr-2"></span>
      Due:
      <span class="font-weight-semibold">2015/02/25</span>
    </span>

    <div id="paypal-button-container"></div>
  </div>
</div>

<% if !@order.paid? %>
<script src="https://www.paypal.com/sdk/js?client-id=<%=@client_id%>"></script>
<script>
  paypal.Buttons({
    env: '<%= @env %>', // Valid values are sandbox and live.
    createOrder: async () => {
        var csrfToken = $("meta[name='csrf-token']").attr("content");
        const config = {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({key: '<%= @order.key %>'})
        }
        const response = await fetch('/orders/pay', config);
        const responseData = await response.json();
        return responseData.token;
    },
    onApprove: async (data) => {
      var csrfToken = $("meta[name='csrf-token']").attr("content");
      const response = await fetch('/orders/capture_order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({token: data.orderID})
      });
      const responseData = await response.json();
      if (responseData.status === 'COMPLETED') {
        alert('Payment success!');
        location.reload();
      }
    }
  }).render('#paypal-button-container');
</script>
<% end %>