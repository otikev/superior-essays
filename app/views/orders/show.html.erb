
<% if @order.paid? %>
  <% class_vals = "card border-left-3 border-left-success rounded-left-0" %>
<% else %>
  <% class_vals = "card border-left-3 border-left-danger rounded-left-0" %>
<% end %>

<div class="<%= class_vals %>">
  <div class="card-body">
    <div class="d-sm-flex align-item-sm-center flex-sm-nowrap">
      <div>
        <h6 class="font-weight-semibold">Topic: <%= @order.topic %></h6>
        <ul class="list list-unstyled mb-0">
          <li>Order #: <%= @order.code %></li>
          <li>Issued on: <span class="font-weight-semibold"><%= @order.created_at%></span></li>
        </ul>
      </div>

      <div class="text-sm-right mb-0 mt-3 mt-sm-0 ml-auto">
        <h6 class="font-weight-semibold">Price: $<%= @order.price%></h6>
        <ul class="list list-unstyled mb-0">
          <li>Order Status: <span class="font-weight-semibold">In Progress</span></li>
          <li>
            Payment Status:
              <% if @order.paid? %>
                <span class="font-weight-semibold badge bg-success badge-pill">Paid</span>
              <% else %>
                <span class="font-weight-semibold badge bg-danger badge-pill">Pending</span>
              <% end %>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card-body">
    <legend class="text-uppercase font-size-sm font-weight-bold">Files</legend>
    <% if @order.resources.count > 0%>
      <div class="list-feed mb-3">
        <div class="list-feed-item">
          <b>My uploaded files</b>
        </div>
        <% @order.resources.each do |resource| %>
          <div class="list-feed-item">
    				<%= resource.name %>
            <%= form_for resource,:html => {:class => 'signup-form'}, :url => url_for(:controller => 'orders', :action => 'delete_resource' ) do |form| %>
              <%= form.hidden_field :id, value: resource.id %>
              <%= button_tag(:class => "btn btn-outline-danger btn-sm") do %>
              Delete
              <% end %>
            <%end%>
    			</div>
        <% end %>
  		</div>
    <% end %>

    <%= form_for @resource,:html => {:class => 'signup-form'}, :url => url_for(:controller => 'orders', :action => 'upload_resource' ) do |form| %>
      <div class="row mb-3">
        <div class="col-lg-12">
          <%= form.text_field :name, placeholder: "File Summary", class: "form-control" , :required=>true %>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-lg-12">
          <%= form.file_field :file, class: "form-control h-auto", :required=>true %>
        </div>
      </div>
      <%= form.hidden_field :order_id, value: @order.id %>
      <%= form.hidden_field :resource_type_id, value: ResourceType.where(name: 'client').first.id %>
      <%= button_tag(:class => "btn bg-success") do %>
      Upload file
      <% end %>
    <%end%>
  </div>

  <div class="card-footer d-sm-flex justify-content-sm-between align-items-sm-center">
    <span>
      <span class="badge badge-mark border-danger mr-2"></span>
      Due:
      <span class="font-weight-semibold">2015/02/25</span>
    </span>

    <div id="paypal-button-container"></div>
  </div>
</div>

<% if !@order.paid? %>
<script src="https://www.paypal.com/sdk/js?client-id=<%=@client_id%>"></script>
<script>
  paypal.Buttons({
    env: '<%= @env %>', // Valid values are sandbox and live.
    //env: 'live', // Valid values are sandbox and live.
    createOrder: async () => {
        const config = {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({key: '<%= @order.key %>'})
        }
        const response = await fetch('/orders/pay', config);
        const responseData = await response.json();
        return responseData.token;
    },
    onApprove: async (data) => {
      const response = await fetch('/orders/capture_order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({token: data.orderID})
      });
      const responseData = await response.json();
      if (responseData.status === 'COMPLETED') {
        alert('Payment success!');
        location.reload();
      }
    }
  }).render('#paypal-button-container');
</script>
<% end %>
